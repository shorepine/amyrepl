<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.min.css" /> 
    <script src="micropython.mjs" type="module"></script>
    <script type="text/javascript" src="enable-threads.js"></script>
    <script type="text/javascript" src="amy.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <script language="javascript">
      var amy_play_message = null;
      var amy_live_start = null;
      var amy_reset_sysclock = null
      var amy_module = null;
      var repl_started = false;

      var mp = null;

      // Once AMY module is loaded, do...
      amyModule().then(async function(am) {
        amy_module = am;
        amy_live_start = amy_module.cwrap(
          'amy_live_start', null, null, {async: true}    
        );
        amy_start = amy_module.cwrap(
          'amy_start', null, ['number', 'number', 'number']
        );
        amy_play_message = amy_module.cwrap(
          'amy_play_message', null, ['string']
        );
        amy_reset_sysclock = amy_module.cwrap(
          'amy_reset_sysclock', null, null
        );
        amy_start(1,1,1,1);
      });
      
      async function start_repl() {
        // Let micropython call an exported AMY function
        await mp.registerJsModule('amy_js_message', amy_play_message);

        mp.registerJsModule("time", {
          sleep: async (s) => await new Promise((r) => setTimeout(r, s * 1000)),
        });

        // Set up the micropython repl, like _boot.py. 
        await mp.runPythonAsync(`
          import amy, amy_js_message, time
          amy.override_send = amy_js_message
        `);
        repl_started = true;
      }

      async function resetAMY() {
        if(repl_started) {
          await mp.runPythonAsync('amy.reset()\n');
        }
      }

      async function runCodeBlock(index) {
        if(repl_started) {
          var py = editors[index].getValue();
          console.log(py)
          amy_reset_sysclock();
          await mp.runPythonAsync(py);
        }
      }

      // Called from first click anywhere on DOM
      async function start_repl_and_audio() {
        // Don't run this twice
        if(repl_started) return;
        // Start the audio worklet (miniaudio)
        await amy_live_start();
        await start_repl();
      }
    
    </script>
    <style>
      .notebookcell {
        .row .px-5 .mt-5 .bg-light .bg-gradient
      }
    </style>
  </head>
  <body>
    <script type="module">
      const stdoutWriter = (line) => {
        console.log(line);
      };

      mp = await loadMicroPython({
        stdout:stdoutWriter, 
        linebuffer: true,
      });
    </script>

    <div class="container-fluid"> 
      <h1>
        <A HREF="https://github.com/shorepine/amy">AMY</A> Notebook demo for DAn
      </h1>

<!-- Put your notebook content here --> 


      <div class="row py-3 my-5 px-5 mx-3 bg-light bg-gradient">
        <p>Hi, i'm going to teach you how to use AMY in Python. You can type or edit the code in this 
        box below, or just run it.</p>

        <div class="editor mb-4">
amy.send(osc=0,freq=220,vel=1)
amy.send(osc=1,freq=440,vel=1)
        </div>
        <p>When you hit play, you should hear two sine waves. (You may have to click twice the first time
          you're on this page, to turn on the audio. It's an anti-autoplay feature your browser has.) 

        <p>Try changing the frequency and running again.
      </div>


      <div class="row py-3 my-5 px-5 mx-3 bg-light bg-gradient">
        <p>OK, again!</p>

        <div class="editor mb-4">
amy.send(voices=0, load_patch=0, vel=1, note=50)
        </div>
        <p>We reset AMY only from the red button, and Python state carries over cell to cell
          like a normal notebook. So you can play multiple cells and AMY can play them both simultaneously.
          We do reset the sample clock to 0 every time you hit play, so you can write code that uses time:
      </div>


      <div class="row py-3 my-5 px-5 mx-3 bg-light bg-gradient">
        <p>Like this</p>

        <div class="editor mb-4">
amy.send(osc=0, wave=amy.PCM, patch=0, time=500, vel=5)
amy.send(osc=0, wave=amy.PCM, patch=1, time=1000, vel=5)
        </div>
        <p><a href="/amyrepl">If you want to use a more normal Python REPL, do that here</a> but the idea of this
          is to make a template for a future blog post / tutorial for AMY that is interactive like this. 
      </div>


    </div>

<!-- End your notebook content -->




    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/codemirror.min.js"
        integrity="sha512-XMlgZzPyVXf1I/wbGnofk1Hfdx+zAWyZjh6c21yGo/k1zNC4Ve6xcQnTDTCHrjFGsOrVicJsBURLYktVEu/8vQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/mode/python/python.min.js"
        integrity="sha512-/mavDpedrvPG/0Grj2Ughxte/fsm42ZmZWWpHz1jCbzd5ECv8CB7PomGtw0NAnhHmE/lkDFkRMupjoohbKNA1Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script> 

    <script language="javascript">
      var editors = [];
      function create_editor(element, index) {
        code = element.textContent;
        element.innerHTML = `
        <div>
          <section class="input">
            <div><textarea id="code-${index}" name="code-${index}"></textarea></div> 
          </section>
          <div class="align-self-center"> 
            <button type="button" class="btn btn-sm btn-success" onclick="runCodeBlock(${index})">►</button> 
            <button type="button" class="btn btn-sm btn-danger" onclick="resetAMY()">◻︎</button> 
          </div>
        </div>`;

        const editor = CodeMirror.fromTextArea(document.getElementById(`code-${index}`), { 
          mode: { 
            name: "python", 
            version: 3, 
            singleLineStringErrors: false
          }, 
          lineNumbers: true, 
          indentUnit: 4, 
          matchBrackets: true
        }); 
        editor.setSize(null,100);
        editor.setValue(code.trim()); 
        editors.push(editor);
      }

        // On click anywhere, start audio and the REPL, after audio is started (otherwise python gets confused about AMY)
      document.body.addEventListener('click', start_repl_and_audio, true); 

      // Replace the editor divs with live editors
      document.querySelectorAll('.editor').forEach(function (element, index) {
        create_editor(element, index);
      });
    </script>

  </body>
</html>


